# Flow Proxy Ops Vault (Telegram Bot)

Приватный Telegram-бот для ручного управления:
- VPS серверами
- оплатами и датами истечения
- базой мануалов/команд

Интерфейс бота полностью на русском языке.

## Почему этот стек
- `Python 3.11` + `aiogram 3.x`: нативный async, быстрый Telegram API слой и удобная маршрутизация.
- `PostgreSQL` + `SQLAlchemy 2.x async`: надежное хранение, типизированные модели.
- `Pydantic v2`: строгая валидация пользовательского ввода.
- `cryptography/Fernet`: шифрование секретов на уровне приложения.
- `APScheduler`: ежедневные напоминания об истечениях.
- `Docker Compose`: быстрый локальный запуск (`bot + db`).

## Возможности
- Приватный доступ только по whitelist (`access_users`).
- Bootstrap первого админа через `ADMIN_TELEGRAM_ID`.
- CRUD-потоки для:
  - VPS (добавление единым шаблоном, список, фильтры, поиск, карточка, архив/восстановление, избранное)
  - Оплат (добавление, истекают 7/30 дней, сводка за месяц)
  - Мануалов (категории, поиск, просмотр, добавление единым шаблоном, редактирование/удаление для админа)
- Секреты хранятся только в зашифрованном виде (`secret_encrypted`).
- Кнопка `Показать секрет` с подтверждением и автоудалением сообщения по TTL.
- Напоминания админам за `14/7/3/1` дней до `expires_at`.
- Экспорт JSON без секретов.

## Ограничения (осознанно)
- Нет автоматического подключения к VPS.
- Нет авто-сбора метрик/нагрузки.
- Нагрузка вводится только вручную в карточке сервера.
- Миграции Alembic не используются.

## Структура проекта
- `bot/` — aiogram роутеры, клавиатуры, middleware, FSM
- `db/` — SQLAlchemy модели и сессии
- `services/` — бизнес-логика
- `crypto/` — шифрование/дешифрование
- `migrations/` — create_all + ручная версия схемы (`schema_version`)
- `tests/` — минимальные тесты

## Сущности БД
- `access_users`: whitelist пользователей и флаг `is_admin`
- `app_settings`: настройки приложения (например TTL секрета)
- `servers`: VPS карточки, ручная нагрузка, статус, избранное, секреты
- `server_tags`: теги серверов
- `billings`: оплаты/истечения
- `manuals`: статьи знаний
- `manual_tags`: теги статей
- `schema_version`: версия схемы для ручных апдейтов

## ENV
Скопируйте `sample.env` в `.env` и заполните значения:
- `BOT_TOKEN`
- `BOT_MASTER_KEY` (Fernet ключ)
- `ADMIN_TELEGRAM_ID`
- `DATABASE_URL`
- `SECRET_TTL_SECONDS` (10..300)
- `NOTIFY_HOUR_UTC` (0..23)

Генерация мастер-ключа:
```bash
python generate_master_key.py
```

## Запуск через Docker Compose
```bash
cp sample.env .env
docker compose up --build
```

## Быстрое добавление (одно сообщение)
- `/add_server` — бот отправляет шаблон сервера + оплаты. Заполните и отправьте одним сообщением.
- `/add_manual` — бот отправляет шаблон мануала. Заполните и отправьте одним сообщением.
- После отправки бот показывает предпросмотр и кнопки `Подтвердить / Отменить`.

## Локальный запуск без Docker
1. Установить Python 3.11+ и PostgreSQL.
2. Установить зависимости:
```bash
pip install .
```
3. Заполнить `.env`.
4. Запустить:
```bash
python -m bot.main
```

## Инициализация схемы и ручные миграции
При старте вызывается `Base.metadata.create_all()`.

Версия схемы хранится в `schema_version`.
Если нужна эволюция схемы:
1. Поднять `CURRENT_SCHEMA_VERSION` в `migrations/schema_manager.py`.
2. Добавить SQL/ALTER в `apply_manual_migrations(...)`.
3. Перезапустить бот.

При небольшом объеме данных допустим полный сброс БД.

## Тесты
```bash
pip install .[dev]
pytest
```

## Безопасность
- Секреты (пароли/ключи) в БД только в ciphertext.
- Ключ шифрования хранится только в ENV (`BOT_MASTER_KEY`).
- Показ секрета требует отдельного подтверждения.
- Сообщение с секретом удаляется по таймеру TTL.
- Пользователи вне whitelist получают: `Доступ запрещён.`
